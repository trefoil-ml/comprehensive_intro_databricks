{"version":"NotebookV1","origId":1745794912677577,"name":"03-Joins-Aggregations","language":"python","commands":[{"version":"CommandV1","origId":1745794912677578,"guid":"4a732259-0fa3-4ed2-a014-e9c8ab3e4a88","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n# Challenge Exercises","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ff229470-5b00-47e8-a9f5-140d28269097"},{"version":"CommandV1","origId":1745794912677579,"guid":"62bd5528-ed7e-4a36-a1a8-3d3ac0e44164","subtype":"command","commandType":"auto","position":3.0,"command":"%md\n### Getting Started\n\nRun the following cell to configure our \"classroom\".","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"22c5ce83-aecc-4d9e-ac13-2a67ed59c670"},{"version":"CommandV1","origId":1745794912677580,"guid":"fec307e0-d31c-43e1-937e-2257462c2715","subtype":"command","commandType":"auto","position":4.0,"command":"%run \"../Includes/Classroom-Setup\"","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"b6f1938a-30a7-4502-b96d-8b4a70ce683b"},{"version":"CommandV1","origId":1745794912677581,"guid":"a6447729-ce48-41ba-a141-d2f4144b1497","subtype":"command","commandType":"auto","position":5.0,"command":"%md\n## Challenge Exercise 3\n\nStarting with the `/mnt/training/ssn/names-1880-2016.parquet/` file, find the most popular first name for girls in 1885, 1915, 1945, 1975, and 2005.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ac9d9139-4ff7-432d-aad9-da5f82720b13"},{"version":"CommandV1","origId":1745794912677582,"guid":"6700c738-94bd-4005-aded-a262a70d5ec4","subtype":"command","commandType":"auto","position":6.0,"command":"%md-sandbox\n### Step 1\nCreate a temporary view called `HistoricNames` where:\n0. You may need to create temporary DataFrames to generate the DataFrame listing the names.\n0. The result has three columns:\n  * `firstName`\n  * `year`\n  * `total`\n\n<img alt=\"Hint\" title=\"Hint\" style=\"vertical-align: text-bottom; position: relative; height:1.75em; top:0.3em\" src=\"https://files.training.databricks.com/static/images/icon-light-bulb.svg\"/>&nbsp;**Hint:** This is an example of a nested `SELECT` if you were to use SQL syntax. Using DataFrames, you will need to craft two queries and perform a `join`.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"7158ad91-3991-45e6-9751-19a0128e243e"},{"version":"CommandV1","origId":1745794912677583,"guid":"d9095039-4424-47d9-81e4-e320f0a3385d","subtype":"command","commandType":"auto","position":7.0,"command":"%md\n### Step 1\n\nLoad `/mnt/training/ssn/names-1880-2016.parquet` into a DataFrame called `ssaDF` and display the schema.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5b9746ca-e860-43d9-b024-4f4f7c5c31a9"},{"version":"CommandV1","origId":1745794912677584,"guid":"be34eae5-a040-4d6e-b029-8b549ac8a940","subtype":"command","commandType":"auto","position":8.0,"command":"# ANSWER\n\nssaDF = spark.read.parquet(\"/mnt/training/ssn/names-1880-2016.parquet/\")\n\nssaDF.printSchema()","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"eed414be-a648-468d-9c65-2a63f87673c6"},{"version":"CommandV1","origId":1745794912677585,"guid":"6c158486-6394-4fc9-920b-682325e7989c","subtype":"command","commandType":"auto","position":9.0,"command":"%md\n### Step 2\n\nCraft a DataFrame query that solves the problem described above.\n\nDisplay the output of the DataFrame.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8f3e1f2f-53bf-4ac6-a330-14f9c5186af4"},{"version":"CommandV1","origId":1745794912677586,"guid":"0c986b28-9c80-4be4-ac9e-2a40d3e6a81d","subtype":"command","commandType":"auto","position":10.0,"command":"# ANSWER\n\nfrom pyspark.sql.functions import col, max\nmaxNamesDF = (ssaDF \n  .select(col(\"year\").alias(\"maxYear\"), \"gender\", \"total\") \n  .groupBy(\"maxYear\", \"gender\") \n  .agg(max(col(\"total\")).alias(\"total\")) \n  .filter(\"gender = 'F' \") \n  .filter(\"maxYear in (1885, 1915, 1945, 1975, 2005)\")\n)\n\nouterQueryDF = (ssaDF \n  .select(\"firstName\", \"year\",col(\"total\").alias(\"outerTotal\")) \n  .filter(\"gender = 'F' \") \n  .filter(\"year in (1885, 1915, 1945, 1975, 2005)\") \n)\n\njoinedQueryDF = (maxNamesDF \n  .join(outerQueryDF, col(\"outerTotal\") == col(\"total\")) \n  .orderBy(\"year\") \n  .drop(\"maxYear\", \"outerTotal\")\n)\n\njoinedQueryDF.show()","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"761c6d71-c158-44b9-a96b-0c3c3ba1fb62"},{"version":"CommandV1","origId":1745794912677587,"guid":"07d3deca-3b77-468d-ae5c-2fcc43ae7d06","subtype":"command","commandType":"auto","position":11.0,"command":"# TEST - Run this cell to test your solution.\n\nresultsDF = joinedQueryDF.select(\"firstName\", \"year\", \"total\")\nresults = [ (r[0]+\" \"+str(r[1])+\": \"+str(r[2])) for r in resultsDF.collect()]\n\ndbTest(\"DF-L3-Opt-historicNames-0\", u'Mary 1885: 9128', results[0])\ndbTest(\"DF-L3-Opt-historicNames-1\", u'Mary 1915: 58187', results[1])\ndbTest(\"DF-L3-Opt-historicNames-2\", u'Mary 1945: 59288', results[2])\ndbTest(\"DF-L3-Opt-historicNames-3\", u'Jennifer 1975: 58186', results[3])\ndbTest(\"DF-L3-Opt-historicNames-4\", u'Emily 2005: 23934', results[4])","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"7364c8fc-223b-493e-a309-0f0fcc4d0eb5"}],"dashboards":[],"guid":"4b3d653b-cfb0-4376-a4fe-0bbeb0f48b8c","globalVars":{},"iPythonMetadata":null,"inputWidgets":{}}