{"version":"NotebookV1","origId":1745794912674721,"name":"03-Joins-Aggregations","language":"scala","commands":[{"version":"CommandV1","origId":1745794912674722,"guid":"6334cb5c-8219-4de7-991c-14c964c1a23c","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n# Challenge Exercises","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"e77eb8d5-74e5-4c3d-b789-2b370a474f62"},{"version":"CommandV1","origId":1745794912674723,"guid":"7114b4e1-36c5-4335-80fd-f859d23c1e17","subtype":"command","commandType":"auto","position":3.0,"command":"%md\n### Getting Started\n\nRun the following cell to configure our \"classroom\".","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"c8b73cdb-09ca-4561-aa0c-7e9d916898bb"},{"version":"CommandV1","origId":1745794912674724,"guid":"88b91937-07eb-4b9b-84b7-62c519092083","subtype":"command","commandType":"auto","position":4.0,"command":"%run \"../Includes/Classroom-Setup\"","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"57982115-a749-4ced-a6de-62d4d3cc2a18"},{"version":"CommandV1","origId":1745794912674725,"guid":"b0545dd3-0dc6-4792-8317-1289d5e0ecc4","subtype":"command","commandType":"auto","position":5.0,"command":"%md\n## Challenge Exercise 3\n\nStarting with the `/mnt/training/ssn/names-1880-2016.parquet/` file, find the most popular first name for girls in 1885, 1915, 1945, 1975, and 2005.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"481dea6e-6683-40a9-a443-1355aba626be"},{"version":"CommandV1","origId":1745794912674726,"guid":"353ee97c-59fb-4ddc-ad1c-9183269a92e1","subtype":"command","commandType":"auto","position":6.0,"command":"%md-sandbox\n### Step 1\nCreate a temporary view called `HistoricNames` where:\n0. You may need to create temporary DataFrames to generate the DataFrame listing the names.\n0. The result has three columns:\n  * `firstName`\n  * `year`\n  * `total`\n\n<img alt=\"Hint\" title=\"Hint\" style=\"vertical-align: text-bottom; position: relative; height:1.75em; top:0.3em\" src=\"https://files.training.databricks.com/static/images/icon-light-bulb.svg\"/>&nbsp;**Hint:** This is an example of a nested `SELECT` if you were to use SQL syntax. Using DataFrames, you will need to craft two queries and perform a `join`.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"3e3baadd-f797-4caa-9514-5f570572b37c"},{"version":"CommandV1","origId":1745794912674727,"guid":"d28ce7bf-cc5b-4a6d-932f-556f420db861","subtype":"command","commandType":"auto","position":7.0,"command":"%md\n### Step 1\n\nLoad `/mnt/training/ssn/names-1880-2016.parquet` into a DataFrame called `ssaDF` and display the schema.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ebcb2800-fe9f-41b0-8225-a363e18d0e52"},{"version":"CommandV1","origId":1745794912674728,"guid":"92ec6d37-9ee1-4498-9bfd-93b8a6a096ae","subtype":"command","commandType":"auto","position":8.0,"command":"// ANSWER\n\nval ssaDF = spark.read.parquet(\"/mnt/training/ssn/names-1880-2016.parquet/\")\n\nssaDF.printSchema()","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"aac29d56-eff2-407d-b023-e7575065a082"},{"version":"CommandV1","origId":1745794912674729,"guid":"082ebb92-9574-4142-94b2-978ec00ebe0d","subtype":"command","commandType":"auto","position":9.0,"command":"%md\n### Step 2\n\nCraft a DataFrame query that solves the problem described above.\n\nDisplay the output of the DataFrame.","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"128464f0-8754-4227-b4a5-fe65da36f735"},{"version":"CommandV1","origId":1745794912674730,"guid":"7a64c2ab-ebad-4afb-b348-70d815fc09f1","subtype":"command","commandType":"auto","position":10.0,"command":"// ANSWER\n\nimport org.apache.spark.sql.functions.max\nval maxNamesDF = ssaDF \n  .select($\"year\" as \"maxYear\", $\"gender\", $\"total\") \n  .groupBy($\"maxYear\", $\"gender\") \n  .agg(max($\"total\") as \"total\") \n  .filter($\"gender\" === \"F\") \n  .filter(\"maxYear in (1885, 1915, 1945, 1975, 2005)\")\n\nval outerQueryDF = ssaDF \n  .select($\"firstName\", $\"year\", $\"total\" as \"outerTotal\") \n  .filter($\"gender\" === \"F\") \n  .filter(\"year in (1885, 1915, 1945, 1975, 2005)\") \n  \nval joinedQueryDF = maxNamesDF \n  .join(outerQueryDF, outerQueryDF(\"outerTotal\") === maxNamesDF(\"total\")) \n  .orderBy($\"year\") \n  .drop($\"maxYear\")\n  .drop($\"outerTotal\")\n  \njoinedQueryDF.show()","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"ede9ab35-3e7b-4637-a808-872720103354"},{"version":"CommandV1","origId":1745794912674731,"guid":"a528b73c-3e17-46ec-8068-eac3cc7207a5","subtype":"command","commandType":"auto","position":11.0,"command":"// TEST - Run this cell to test your solution.\n\nlazy val results = joinedQueryDF.select(\"firstName\", \"year\", \"total\").collect()\n\ndbTest(\"DF-L3-Opt-historicNames-0\", Row(\"Mary\", 1885, 9128), results(0))\ndbTest(\"DF-L3-Opt-historicNames-1\", Row(\"Mary\", 1915, 58187), results(1))\ndbTest(\"DF-L3-Opt-historicNames-2\", Row(\"Mary\", 1945, 59288), results(2))\ndbTest(\"DF-L3-Opt-historicNames-3\", Row(\"Jennifer\", 1975, 58186), results(3))\ndbTest(\"DF-L3-Opt-historicNames-4\", Row(\"Emily\", 2005, 23934), results(4))","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"4258953226069350","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"9749f457-bd49-4685-a8b0-51999ae9c495"}],"dashboards":[],"guid":"c09655dd-4aa5-475f-bf7d-91da64477c21","globalVars":{},"iPythonMetadata":null,"inputWidgets":{}}